<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title> Dashboard </title>
	<meta name="description" content="">
	<meta name="author" content="">
	<style>
		.visitReportHelp {
			font-size: 18px;
			float: right;
			text-align: center;
			position: relative;
			min-width: 35px;
			line-height: 32px;
			border-left: 1px solid rgba(0, 0, 0, .09);
		}
	</style>
</head>

<body class="">
	<div id="ribbon">
		<!-- breadcrumb -->
		<ol class="breadcrumb">
			<li>Visit Report</li>
		</ol>
	</div>
	<div id="noresultdialogvisitscreen" title="">
		<p>
			No result found, try changing the search criteria.
		</p>
	</div>
	<div id="content">
		<!-- row -->
		<div class="row">
			<div class="col-xs-12 col-sm-12 col-md-5 col-lg-4">
				<h1 class="page-title txt-color-blueDark" id="storeName"><i class="fa-fw fa fa-briefcase"></i> Visit
					Report</h1>
			</div>
		</div>
		<section id="widget-grid" class="">
			<div class="row">
				<div class="col-sm-12 col-md-12 col-lg-12">
					<div class="jarviswidget" id="wid-id-20" data-widget-colorbutton="false"
						data-widget-fullscreenbutton="false" data-widget-editbutton="false"
						data-widget-deletebutton="false" data-widget-sortable="false">
						<header>
							<span class="widget-icon"> <i class="glyphicon glyphicon-stats txt-color-darken"></i>
							</span>
							<h2>Report Parameter</h2>
							<div class="visitReportHelp">
								<a onclick="infoGuideVisitView('visitReport');">
									<i class="fa fa-question-circle" aria-hidden="true" title="Help"
										style="cursor:pointer"></i>
								</a>
							</div>
						</header>
						<div class="no-padding">
							<div class="panel-wrapper collapse in">
								<div class="filter-outlet activate">
									<form action="" id="visitFilterForm" class="smart-form" novalidate="novalidate">

										<fieldset>
											<div class="row">
												<section class="col col-6">
													<label class="select">
														<select name="UserId" id="salesRepForVisitReport">
															<option value="0" selected="" disabled="">BD</option>
														</select> <i></i>
													</label>
												</section>
												<section class="col col-6">
													<label class="select">
														<select name="TimeRange" id="timeRangeVisit">
															<option value="0" selected="" disabled="">Time Range
															</option>
															<option value="1">Today</option>
															<option value="2">Yesterday</option>
															<option value="3">Last Week</option>
															<option value="4">Last Month</option>
															<option value="5">Last 3 Months</option>
														</select> <i></i>
													</label>
												</section>
											</div>
											<div class="row">
												<section class="col col-6">
													<label class="select">
														<select name="LocationId" id="locationVisit">
															<option value="0" selected="" disabled="">Select Outlet
															</option>
														</select> <i></i>
													</label>
												</section>
												<section class="col col-6">
													<label class="input">
														<i class="icon-append fa fa-calendar"></i>
														<input type="text" name="startDate" id="startdateVisit"
															placeholder="From" class="datepicker">
													</label>
													<label class="input">
														<i class="icon-append fa fa-calendar"></i>
														<input type="text" name="endDate" id="endDateVisit"
															placeholder="To" class="datepicker">
													</label>
												</section>
											</div>
											<div class="row">
												<section class="col col-6">
													<label class="filter-form-group">Category</label>
													<div class="inline-group">
														<label class="radio">
															<input type="radio" name="Status" id="All" checked="checked"
																value="All">
															<i></i>All
														</label>
														<label class="radio">
															<input type="radio" name="Status" id="Found" value="Found">
															<i></i>Found
														</label>
														<label class="radio">
															<input type="radio" name="Status" id="WrongLocation"
																value="WrongLocation">
															<i></i>Wrong Location
														</label>
														<label class="radio">
															<input type="radio" name="Status" id="Missing"
																value="Missing">
															<i></i>Missing
														</label>
													</div>
												</section>
											</div>
										</fieldset>
										<footer>
											<button type="reset" id="filterVisitReset" class="btn btn-primary">
												Reset
											</button>
											<button type="submit" id="filterVisitSubmit" class="btn btn-primary">
												Search
											</button>
										</footer>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<article class="col-sm-12 col-md-12 col-lg-12">
					<div class="jarviswidget" data-widget-colorbutton="false" data-widget-fullscreenbutton="false"
						data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-sortable="false">
						<header>
							<span class="widget-icon"> <i class="glyphicon glyphicon-stats txt-color-darken"></i>
							</span>
							<h2 id="coolerDetailContainer" style="display: -webkit-box;">Details</h2>
							<div class="visitReportHelp">
								<a onclick="infoGuideVisitView('visitReportDetail');">
									<i class="fa fa-question-circle" aria-hidden="true" title="Help"
										style="cursor:pointer"></i>
								</a>
							</div>
						</header>
						<div id="visitReport" class="no-padding " style="overflow: auto; max-height: 25em;">
							<script id="some-template" type="text/x-handlebars-template">
								<table class="table table-striped table-hover table-condensed table-responsive" width="100%">
									<thead>
									<th>Start Date</th>
									<th>Start Time</th>
									<th>Duration</th>
									<th>Outlet Code</th>
									<th>Outlet</th>
									<th>BD Name</th>
									<th>Scan Location</th>
									</thead>
									<tbody>
										{{#visit}}
										<tr>
											<td>{{dateRenderer StartTime}}</td>
											<td>{{timeRenderer StartTime}}</td>
											<td>{{durationRenderer  startTime=StartTime endTime=StopTime}}</td>
											<td>{{LocationCode}}</td>
											<td>{{LocationName}}</td>
											<td>{{VisitBy}}</td>
											<td>{{locationRenderer Latitude=StartLatitude Longitude=StartLongitude}}</td>
											<td>
												<table class="table table-striped table-hover table-condensed table-responsive" width="100%">
													<thead>
													<th>Serial Number</th>
													<th>Distance</th>
													<th>Status</th>
													</thead>
													<tbody>
														{{#details}}
														<tr>
															<td>{{SerialNumber}}</td>
															<td>{{distanceRenderer Distance}}</td>
															<td class="{{Status}}" style="width:30%">{{Status}}</td>
														</tr>
														{{/details}}
													</tbody>
												</table>
											</td>
										</tr>
										{{/visit}}
									</tbody>
								</table>
							</script>
						</div>
					</div>
				</article>
			</div>
		</section>
	</div>
	<script>
		$(document).ready(function () {
			coolerDashboard.common.setFilter();
			var currentUrl = window.location.href;
			if (currentUrl.indexOf('LocationMap#salesHierarchy') > 0) {
				$('#bodyId').addClass('no-menu');
				$("#userInfo").remove();
			} else if (currentUrl.indexOf('irsignup') > 0 || currentUrl.indexOf('outletDetailsIR') > 0) {
				$('#bodyId').addClass('no-menu');
			} else {
				$('#bodyId').removeClass('no-menu');
			}

			$('#noresultdialogvisitscreen').dialog({
				autoOpen: false,
				width: 320,
				height: 100,
				resizable: false,
				modal: true,
				title: "Info"
			});

			// START AND FINISH DATE
			$('#startdateVisit').datepicker({
				dateFormat: 'yy-mm-dd',
				prevText: '<i class="fa fa-chevron-left"></i>',
				nextText: '<i class="fa fa-chevron-right"></i>',
				onSelect: function (selectedDate) {
					$('#endDateVisit').datepicker('option', 'minDate', selectedDate);
				}
			});

			$('#endDateVisit').datepicker({
				dateFormat: 'yy-mm-dd',
				prevText: '<i class="fa fa-chevron-left"></i>',
				nextText: '<i class="fa fa-chevron-right"></i>',
				onSelect: function (selectedDate) {
					$('#startdateVisit').datepicker('option', 'maxDate', selectedDate);
				}
			});


			var source = $("#some-template").html();
			var template = Handlebars.compile(source);
			Handlebars.registerHelper('dateRenderer', function (date) {
				return coolerDashboard.common.dateWithFormat(date, '-', 'date');
			});

			Handlebars.registerHelper('timeRenderer', function (date) {
				return coolerDashboard.common.dateWithFormat(date, '-', 'time');
			});

			Handlebars.registerHelper('durationRenderer', function (option) {
				return coolerDashboard.common.dateDiff(coolerDashboard.common.parseDate(option.hash.endTime),
					coolerDashboard.common.parseDate(option.hash.startTime));
			});

			Handlebars.registerHelper('locationRenderer', function (option) {
				return coolerDashboard.renderers.geo('', '', option.hash)
			});

			Handlebars.registerHelper('distanceRenderer', function (distance) {
				return distance && distance != "" ? distance.toFixed(2) + " KM" : "";
			});

			$("#timeRangeVisit").on('change', function () {
				var localFormat = 'YYYY-MM-DD';
				var value = Number(this.value);
				var today = moment();
				var startValue = moment.utc().startOf('day');
				var endValue = moment.utc().endOf('day');
				switch (value) {
					case 1:
						startValue = moment.utc().startOf('day');
						endValue = moment.utc().endOf('day');
						break;
					case 2:
						startValue = moment.utc().subtract(1, 'days').startOf('day');
						endValue = moment.utc().subtract(1, 'days').endOf('day');
						break;
					case 3:
						startValue = moment.utc().subtract(moment().weekday() + 7, 'days').startOf('day');
						endValue = moment.utc().subtract(moment().weekday() + 1, 'days').endOf('day');
						break;
					case 4:
						startValue = moment.utc().subtract(1, 'months').startOf('month');
						endValue = moment.utc().subtract(1, 'months').endOf('month');
						break;
					case 5:
						startValue = moment.utc().subtract(3, 'months').startOf('month');
						endValue = moment.utc().subtract(1, 'months').endOf('month');
						break;
					default:
						break;
				}
				$('#startdateVisit').val(startValue.format(localFormat));
				$('#endDateVisit').val(endValue.format(localFormat));
			});


			$('#visitFilterForm').submit(function (e) {
				e.preventDefault();
				// todo: validation
				var data = $(this).serializeArray();
				filterValues = {};
				var form = $(this);

				var config = {};
				jQuery(form).serializeArray().map(function (item) {
					if (config[item.name]) {
						if (typeof (config[item.name]) === "string") {
							config[item.name] = [config[item.name]];
						}
						config[item.name].push(item.value);
					} else {
						config[item.name] = item.value;
					}
				});
				switch (config.Status) {
					case "Found":
						config.Found = "0";
						config.Found_operator = ">";
						break;
					case "WrongLocation":
						config.WrongLocation = "0";
						config.WrongLocation_operator = ">";
						break;
					case "Missing":
						config.Missing = "0";
						config.Missing_operator = ">";
						break;
					default:
						break;
				}

				//For all Locations.
				if (config.LocationId == 0) {
					delete config.LocationId;
				}

				//For all salesrep.
				if (config.UserId == 0) {
					delete config.UserId;
				}
				var endValue = $('#endDateVisit').val()
				var localFormat = 'YYYY-MM-DD';
				if (config.startDate) {
					var startValue = config.startDate;
					startValue = moment.utc(startValue);
					config.StartTime = startValue.format(localFormat);
					config.StartTime_operator = ">=";
				}
				if (config.endDate) {
					var endValue = config.endDate;
					endValue = moment.utc(endValue);
					config.StartTime_To = endValue.endOf('day').format();
					config.StartTime_To_operator = "<=";
				}
				config.limit = 10000;
				$.ajax({
					url: coolerDashboard.common.nodeUrl('visit/list'),
					method: 'GET',
					data: config,
					success: function (data, request) {
						var html = template({
							"visit": data.data
						});

						if (data.data.length == 0) {
							$('#noresultdialogvisitscreen').dialog('open');
						}
						$('#visitReport').html(html);
					},
					failure: function (response, opts) {}
				});
			});


			$('#filterVisitReset').on('click', function () {
				var myForm = $('#visitFilterForm').get(0);
				myForm.reset();
				$("select", myForm).each(
					function () {
						$(this).select('val', $(this).find('option:selected').val());
					}
				);
				//$(this).submit();
				$('#visitReport').html("");
			});
		});

		function infoGuideVisitView(sectionId) {
			window.open('#InfoGuide#index=' + sectionId);
		}
	</script>
</body>

</html>